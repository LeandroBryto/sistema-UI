<div class="page-container">
  <header class="header">
    <div>
      <p class="muted">Gerencie e acompanhe seus gastos</p>
    </div>
    <div class="summary">
      <div class="chip">Itens: {{ itens.length }}</div>
      <a class="secondary link" routerLink="/dashboard">Voltar ao Dashboard</a>
    </div>
  </header>

  <section class="filters card">
    <div class="row">
      <label>Início</label>
      <input type="date" [formControl]="filtros.controls.startDate" />
    </div>
    <div class="row">
      <label>Fim</label>
      <input type="date" [formControl]="filtros.controls.endDate" />
    </div>
    <div class="row actions">
      <p-button [label]="loading ? 'Carregando...' : 'Aplicar Filtros'" severity="primary" [disabled]="loading" [loading]="loading" (onClick)="load()"></p-button>
    </div>
  </section>

  <p class="error" *ngIf="error">{{ error }}</p>
  <p-toast position="top-right"></p-toast>

  <div class="grid two">
    <section class="card form-card">
      <h3>{{ editingId ? 'Editar Despesa' : 'Nova Despesa' }}</h3>
      <form [formGroup]="form" (ngSubmit)="save()">
        <div class="form-grid">
          <div class="row">
            <label>Descrição</label>
            <input type="text" formControlName="descricao" />
          </div>
          <div class="row">
            <label>Categoria</label>
            <select formControlName="categoria">
              <option value="" disabled>Selecione</option>
              <option *ngFor="let c of categorias" [value]="c">{{ c }}</option>
            </select>
          </div>
          <div class="row">
            <label>Valor</label>
            <input type="number" step="0.01" formControlName="valor" />
          </div>
          <div class="row">
            <label>Data</label>
            <input type="date" formControlName="data" />
          </div>
          <div class="row">
            <div class="field">
              <label>Forma de Pagamento</label>
              <p-dropdown [options]="formas" formControlName="formaPagamento" placeholder="Selecione..."></p-dropdown>
            </div>
            
            <!-- Seleção dinâmica: Carteira ou Cartão -->
            <div class="field" *ngIf="form.get('formaPagamento')?.value === 'CARTAO_CREDITO'">
              <label>Cartão de Crédito</label>
              <p-dropdown [options]="cartoes" formControlName="cartaoCreditoId" optionLabel="nome" optionValue="id" placeholder="Selecione o Cartão"></p-dropdown>
            </div>

            <div class="field" *ngIf="form.get('formaPagamento')?.value && form.get('formaPagamento')?.value !== 'CARTAO_CREDITO'">
              <label>Conta de Saída</label>
              <p-dropdown [options]="carteiras" formControlName="carteiraId" optionLabel="nome" optionValue="id" placeholder="Selecione a Conta"></p-dropdown>
            </div>

            <div class="field">
              <label>Status</label>
              <p-dropdown [options]="status" formControlName="statusPagamento" placeholder="Selecione..."></p-dropdown>
            </div>
          </div>
          <div class="row checkbox">
            <label>
              <input type="checkbox" formControlName="recorrente" />
              Recorrente
            </label>
          </div>
          <div class="row">
            <label>Notificar antes (dias)</label>
            <input type="number" formControlName="notificarAntesVencimento" />
          </div>
          <div class="row wide">
            <label>Observações</label>
            <textarea rows="3" formControlName="observacoes"></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button class="primary" type="submit" [disabled]="form.invalid || loading">
            {{ editingId ? 'Salvar Alterações' : 'Criar' }}
          </button>
          <button type="button" class="secondary" (click)="resetForm()">Limpar</button>
        </div>
      </form>
    </section>

    <section class="card list-card">
      <div class="list-head">
        <h3>Lista</h3>
        <input pInputText type="text" placeholder="Filtrar..." [(ngModel)]="globalFilter" (input)="dt.filterGlobal(globalFilter, 'contains')" />
      </div>
      <p-table #dt [value]="itens" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10,20,50]" [responsiveLayout]="'stack'" styleClass="expenses-table">
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="descricao">Descrição <p-sortIcon field="descricao"></p-sortIcon>
              <p-columnFilter field="descricao" type="text" display="menu"></p-columnFilter>
            </th>
            <th pSortableColumn="categoria">Categoria <p-sortIcon field="categoria"></p-sortIcon>
              <p-columnFilter field="categoria" type="text" display="menu"></p-columnFilter>
            </th>
            <th pSortableColumn="valor">Valor <p-sortIcon field="valor"></p-sortIcon>
              <p-columnFilter field="valor" type="numeric" display="menu"></p-columnFilter>
            </th>
            <th pSortableColumn="data">Data <p-sortIcon field="data"></p-sortIcon>
              <p-columnFilter field="data" type="date" display="menu"></p-columnFilter>
            </th>
            <th>Forma
              <p-columnFilter field="formaPagamento" display="menu">
                <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                  <p-dropdown [options]="formas" [ngModel]="value" (onChange)="filter($event.value)" placeholder="Qualquer"></p-dropdown>
                </ng-template>
              </p-columnFilter>
            </th>
            <th>Status
              <p-columnFilter field="statusPagamento" matchMode="equals" [showMatchModes]="false" display="menu">
                <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                  <p-dropdown [options]="status" [ngModel]="value" (onChange)="filter($event.value)" placeholder="Qualquer"></p-dropdown>
                </ng-template>
              </p-columnFilter>
            </th>
            <th>Recorrente
              <p-columnFilter field="recorrente" matchMode="equals" [showMatchModes]="false" display="menu">
                <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                  <p-dropdown [options]="[{label: 'Sim', value: true}, {label: 'Não', value: false}]" [ngModel]="value" (onChange)="filter($event.value)" placeholder="Qualquer"></p-dropdown>
                </ng-template>
              </p-columnFilter>
            </th>
            <th>Observações
              <p-columnFilter field="observacoes" type="text" display="menu"></p-columnFilter>
            </th>
            <th>Ações</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td><span class="p-column-title">Descrição</span>{{ item.descricao }}</td>
            <td><span class="p-column-title">Categoria</span>{{ item.categoria }}</td>
            <td><span class="p-column-title">Valor</span>R$ {{ item.valor | number : '1.2-2' }}</td>
            <td><span class="p-column-title">Data</span>{{ item.data }}</td>
            <td><span class="p-column-title">Forma</span>{{ item.formaPagamento }}</td>
            <td>
              <span class="p-column-title">Status</span>
              <p-tag [value]="item.statusPagamento" [severity]="item.statusPagamento==='PAGO' ? 'success' : (item.statusPagamento==='ATRASADO' ? 'danger' : 'warning')"></p-tag>
            </td>
            <td>
              <span class="p-column-title">Recorrente</span>
              <p-tag [value]="item.recorrente ? 'Sim' : 'Não'" [severity]="item.recorrente ? 'success' : 'secondary'"></p-tag>
            </td>
            <td>
              <span class="p-column-title">Observações</span>
              {{ item.observacoes }}
              <span class="notify" *ngIf="item.notificarAntesVencimento">{{ item.notificarAntesVencimento }}d</span>
            </td>
            <td class="actions">
              <span class="p-column-title">Ações</span>
              <button pButton type="button" label="Editar" class="p-button-sm" (click)="edit(item)"></button>
              <button pButton type="button" severity="danger" label="Excluir" class="p-button-sm" (click)="remove(item)"></button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="9">Nenhuma despesa encontrada para o período.</td>
          </tr>
        </ng-template>
      </p-table>
    </section>
  </div>
</div>
