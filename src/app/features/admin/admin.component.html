<div class="page-container">
  <header class="head">
    <h2>Painel de Controle</h2>
    <div class="actions">
      <a class="secondary link" routerLink="/dashboard" (click)="goDashboard()">Voltar ao Dashboard</a>
      <span class="badge">ADMIN</span>
    </div>
  </header>

<p class="error" *ngIf="error">{{ error }}</p>
<div class="loading" *ngIf="loading">Carregando...</div>

<section class="grid two" *ngIf="!loading">
  <div class="card">
    <h3>Usuários</h3>
    <div class="table">
      <div class="thead">
        <span>ID</span><span>Username</span><span>Email</span><span>Status</span><span>Role</span><span>Ações</span>
      </div>
      <div class="row" *ngFor="let u of users; let i = index" [class.alt]="i % 2 === 1">
        <span class="col-id" data-label="ID">{{ u.id }}</span>
        <span class="col-user" data-label="Username">{{ u.username }}</span>
        <span class="col-email" data-label="Email">{{ u.email }}</span>
        <span class="col-status" data-label="Status"><span class="chip" [class.ok]="u.status==='ATIVO'" [class.warn]="u.status==='BLOQUEADO'">{{ u.status }}</span></span>
        <span class="col-role" data-label="Role"><span class="chip info">{{ u.role }}</span></span>
        <span class="actions" data-label="Ações">
          <button class="sm" (click)="activate(u)" [disabled]="u.status==='ATIVO'">Ativar</button>
          <button class="sm" (click)="deactivate(u)" [disabled]="u.status==='BLOQUEADO'">Desativar</button>
          <form [formGroup]="roleForm" (ngSubmit)="changeRole(u)" class="inline">
            <select formControlName="role">
              <option value="USER">USER</option>
              <option value="ADMIN">ADMIN</option>
            </select>
            <button class="sm" type="submit">Alterar</button>
          </form>
          <button class="sm warn" (click)="openResetDialog(u)">Resetar Senha</button>
        </span>
      </div>
    </div>
  </div>
<!-- 
  <div class="card">
    <h3>Métricas</h3>
    <div *ngIf="metrics; else noMetrics" class="metrics">
      <div><span class="label">Total</span><span class="value">{{ metrics.totalUsuarios }}</span></div>
      <div><span class="label">Ativos</span><span class="value">{{ metrics.usuariosAtivos }}</span></div>
      <div><span class="label">Admins</span><span class="value">{{ metrics.administradores }}</span></div>
    </div>
    <ng-template #noMetrics><p class="muted">Sem métricas</p></ng-template>
  </div> -->
</section>

<p-toast position="top-right"></p-toast>

<p-dialog [(visible)]="showResetDialog" [modal]="true" [closable]="true" (onHide)="closeResetDialog()" [style]="{ width: '420px' }" header="Resetar Senha">
  <div *ngIf="userToReset as user">
    <p class="muted" style="margin-top:0">Usuário: <strong>{{ user.username }}</strong></p>
    <form [formGroup]="resetForm" (ngSubmit)="confirmReset()" class="form-grid" style="margin-top:8px">
      <div class="row">
        <label>Nova senha</label>
        <p-password formControlName="password" [toggleMask]="true" [feedback]="false"></p-password>
      </div>
      <div class="row">
        <label>Confirmar senha</label>
        <p-password formControlName="confirm" [toggleMask]="true" [feedback]="false"></p-password>
      </div>
      <div class="form-actions" style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end">
        <p-button type="button" label="Cancelar" severity="secondary" (onClick)="closeResetDialog()"></p-button>
        <p-button type="submit" label="Confirmar" severity="primary" [disabled]="resetForm.invalid || resetForm.get('password')?.value !== resetForm.get('confirm')?.value"></p-button>
      </div>
    </form>
  </div>
</p-dialog>

<section class="grid two" *ngIf="!loading">
  <div class="card">
    <h3>Últimos Logins</h3>
    <div class="table-responsive">
      <table class="simple-table" *ngIf="last && last.length; else sampleLast">
        <thead>
          <tr><th>Usuário</th><th>Quando</th></tr>
        </thead>
        <tbody>
          <tr *ngFor="let u of last"><td>{{ u.username }}</td><td>{{ formatDate(u.ultimaAtualizacao) }}</td></tr>
        </tbody>
      </table>
    </div>
    <ng-template #sampleLast>
      <div class="table-responsive">
        <table class="simple-table">
          <thead>
            <tr><th>Usuário</th><th>Quando</th></tr>
          </thead>
          <tbody>
            <tr><td>leandro ba</td><td>16/12/2025 01:25:12</td></tr>
            <tr><td>leandro g</td><td>16/12/2025 01:02:01</td></tr>
            <tr><td>leandro brito</td><td>15/12/2025 14:34:56</td></tr>
            <tr><td>leandro iesb</td><td>14/12/2025 19:28:26</td></tr>
            <tr><td>user1</td><td>13/12/2025 23:13:40</td></tr>
            <tr><td>teste b</td><td>13/12/2025 22:16:15</td></tr>
            <tr><td>leandro b</td><td>13/12/2025 20:50:48</td></tr>
          </tbody>
        </table>
      </div>
    </ng-template>
  </div>
  <div class="card">
    <h3>Status</h3>
    <p *ngIf="status">{{ status.status }} — {{ formatDate(status.timestamp) }}</p>
    <p *ngIf="!status" class="muted">UP — 16/12/2025 01:37:58</p>
  </div>
</section>
<form class="card filters filters-inline" [formGroup]="filterForm" (ngSubmit)="refresh()">
  <div class="row">
    <label>Últimos logins</label>
    <p-dropdown formControlName="lastLimit" [options]="[{label:'5', value:5},{label:'10', value:10},{label:'20', value:20}]" [style]="{width:'180px'}"></p-dropdown>
  </div>
  <div class="row">
    <label>Auditoria</label>
    <p-dropdown formControlName="auditLimit" [options]="[{label:'20', value:20},{label:'50', value:50},{label:'100', value:100}]" [style]="{width:'180px'}"></p-dropdown>
  </div>
  <div class="row">
    <label>Filtrar ação</label>
    <select formControlName="action" (change)="applyAuditFilter()" style="width:180px; height:32px; font-size:12px;">
      <option value="ALL">Todas</option>
      <option value="ACTIVATE">Ativar</option>
      <option value="DEACTIVATE">Desativar</option>
      <option value="CHANGE_ROLE">Alterar role</option>
      <option value="RESET_PASSWORD">Resetar senha</option>
    </select>
  </div>
  <div class="row">
    <p-button type="submit" label="Aplicar" severity="primary" size="small"></p-button>
    <p-button type="button" label="Atualizar Status" severity="secondary" size="small" (onClick)="refreshStatus()"></p-button>
  </div>
</form>
<section class="card" *ngIf="!loading">
  <h3>Auditoria</h3>
  <div class="table audit">
    <div class="thead">
      <span>ID</span><span>Admin</span><span>User</span><span>Ação</span><span>Quando</span><span>Detalhes</span>
    </div>
    <div class="row" *ngFor="let a of auditFiltered; let i = index" [class.alt]="i % 2 === 1">
      <span data-label="ID">{{ a.id }}</span>
      <span data-label="Admin">{{ a.adminUsername }}</span>
      <span data-label="User ID">{{ a.userId }}</span>
      <span data-label="Ação"><span class="chip" [class]="actionClass(a.action)">{{ a.action }}</span></span>
      <span data-label="Quando">{{ formatDate(a.timestamp) }}</span>
      <span class="ellipsis" [title]="a.details || '—'" data-label="Detalhes">{{ a.details || '—' }}</span>
    </div>
  </div>
</section>
</div>

