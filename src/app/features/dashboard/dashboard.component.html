<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header flex justify-content-between align-items-center mb-5">
    <div>
      <h1 class="text-3xl font-bold m-0">Dashboard</h1>
      <p class="text-color-secondary mt-1">Visão geral da sua carteira</p>
    </div>
    <div class="header-actions flex gap-3 align-items-center">
      <!-- AI Assistant -->
      <button class="btn-ai-glow" (click)="openAiAssistant()" pTooltip="Assistente Financeiro IA" tooltipPosition="bottom" aria-label="Abrir Assistente IA">
        <i class="pi pi-sparkles text-xl"></i>
        <span class="ml-2 font-bold hidden md:inline">AI Assist</span>
      </button>

      <button class="btn-outlined" (click)="summaryVisible = true" pTooltip="Relatórios e Resumo" tooltipPosition="bottom">
        <i class="pi pi-chart-bar mr-2"></i> Relatórios
      </button>

    </div>
  </div>

  <!-- KPI Grid -->
  <div class="kpi-grid">
    <div class="card kpi-card">
      <div class="kpi-content">
        <span class="kpi-label">Receitas</span>
        <span class="kpi-value">R$ {{ kpis.receitas.value | number:'1.2-2' }}</span>
        <div class="kpi-trend" [ngClass]="kpis.receitas.trend >= 0 ? 'ok' : 'warn'">
          <i class="pi" [ngClass]="kpis.receitas.trend >= 0 ? 'pi-arrow-up' : 'pi-arrow-down'"></i>
          <span>{{ kpis.receitas.trend | number:'1.1-1' }}% {{ kpis.receitas.trendLabel }}</span>
        </div>
      </div>
      <div class="kpi-icon-wrapper">
        <i class="pi pi-dollar text-xl text-green-400"></i>
      </div>
    </div>

    <div class="card kpi-card">
      <div class="kpi-content">
        <span class="kpi-label">Despesas</span>
        <span class="kpi-value">R$ {{ kpis.despesas.value | number:'1.2-2' }}</span>
        <div class="kpi-trend" [ngClass]="kpis.despesas.trend <= 0 ? 'ok' : 'warn'">
          <i class="pi" [ngClass]="kpis.despesas.trend >= 0 ? 'pi-arrow-up' : 'pi-arrow-down'"></i>
          <span>{{ kpis.despesas.trend | number:'1.1-1' }}% {{ kpis.despesas.trendLabel }}</span>
        </div>
      </div>
      <div class="kpi-icon-wrapper">
        <i class="pi pi-shopping-cart text-xl text-red-400"></i>
      </div>
    </div>

    <div class="card kpi-card">
      <div class="kpi-content">
        <span class="kpi-label">Saldo Atual</span>
        <span class="kpi-value">
          {{ kpis.saldo.value > 0 ? '+' : '' }}R$ {{ kpis.saldo.value | number:'1.2-2' }}
        </span>
        <div class="kpi-trend" [ngClass]="kpis.saldo.trend >= 0 ? 'ok' : 'warn'">
          <i class="pi" [ngClass]="kpis.saldo.trend >= 0 ? 'pi-arrow-up' : 'pi-arrow-down'"></i>
          <span>{{ kpis.saldo.trend | number:'1.1-1' }}% {{ kpis.saldo.trendLabel }}</span>
        </div>
      </div>
      <div class="kpi-icon-wrapper">
        <i class="pi pi-wallet text-xl text-blue-400"></i>
      </div>
    </div>

    <div class="card kpi-card">
      <div class="kpi-content">
        <span class="kpi-label">Investimentos</span>
        <span class="kpi-value">R$ {{ kpis.investimentos.value | number:'1.2-2' }}</span>
        <div class="kpi-trend ok">
          <i class="pi pi-chart-line"></i>
          <span>+2.4% rendimento</span>
        </div>
      </div>
      <div class="kpi-icon-wrapper">
        <i class="pi pi-briefcase text-xl text-purple-400"></i>
      </div>
    </div>
  </div>

  <!-- Middle Section: Charts -->
  <div class="middle-grid">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Fluxo de Caixa</h3>
        <div class="flex gap-2">
          <button class="btn-text">Semanal</button>
          <button class="btn-text text-white">Mensal</button>
        </div>
      </div>
      <div class="chart-wrapper">
        <p-chart type="line" [data]="revenueChart" [options]="chartOptions" height="100%"></p-chart>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Despesas por Categoria</h3>
      </div>
      <div class="chart-wrapper">
        <!-- Using the same chart for now, ideally pie chart -->
        <p-chart type="line" [data]="expenseChart" [options]="chartOptions" height="100%"></p-chart>
      </div>
    </div>
  </div>

  <!-- Bottom Section: Transactions & Goals -->
  <div class="bottom-grid">
    <div class="card col-span-2" style="grid-column: span 2;">
      <div class="card-header">
        <h3 class="card-title">Transações Recentes</h3>
        <button class="btn-text">Ver todas</button>
      </div>
      <div class="transactions-list">
        <div class="list-header">
          <span>Descrição</span>
          <span>Data</span>
          <span class="text-right">Valor</span>
        </div>
        <div *ngFor="let item of recentTransactions" class="list-item">
          <div class="flex align-items-center gap-3">
            <div class="item-icon" [ngClass]="item.type">
              <i [class]="item.icon"></i>
            </div>
            <span class="font-medium text-gray-200">{{ item.descricao }}</span>
          </div>
          <span class="text-gray-400 text-sm">{{ item.data | date:'dd/MM/yyyy' }}</span>
          <span class="text-right font-medium" [class.text-red-400]="item.type === 'expense'" [class.text-green-400]="item.type === 'income'">
            {{ item.type === 'expense' ? '-' : '+' }} R$ {{ item.valor | number:'1.2-2' }}
          </span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Objetivos</h3>
      </div>
      <div class="flex flex-column gap-4">
        <div class="goal-item">
          <div class="goal-info">
            <span>Reserva de Emergência</span>
            <span class="text-blue-400">65%</span>
          </div>
          <div class="progress-bg">
            <div class="progress-fill" style="width: 65%"></div>
          </div>
          <div class="text-xs text-gray-400 mt-1">R$ 13.000 / R$ 20.000</div>
        </div>
        
        <div class="goal-item">
          <div class="goal-info">
            <span>Viagem Férias</span>
            <span class="text-cyan-400">30%</span>
          </div>
          <div class="progress-bg">
            <div class="progress-fill" style="width: 30%; background: linear-gradient(90deg, #06b6d4, #22d3ee);"></div>
          </div>
          <div class="text-xs text-gray-400 mt-1">R$ 3.000 / R$ 10.000</div>
        </div>
        
        <div class="p-4 rounded-lg border border-dashed border-gray-700 text-center text-gray-400 text-sm mt-2" style="background: rgba(255,255,255,0.02)">
          <i class="pi pi-plus mb-2 block text-xl"></i>
          Novo Objetivo
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Right Sidebar for Summary -->
<p-sidebar [(visible)]="summaryVisible" position="right" [baseZIndex]="10000" styleClass="w-full md:w-30rem bg-card border-l border-gray-800">
  <div class="flex flex-column h-full p-4" style="background: #0b1324; height: 100%;">
    <h2 class="text-xl font-bold mb-6 text-blue-400">Resumo Financeiro</h2>
    
    <div class="flex flex-column gap-4">
      <div class="p-4 rounded-xl border border-blue-900" style="background: rgba(59, 130, 246, 0.1);">
        <span class="text-sm text-blue-400 block mb-1">Saldo Total</span>
        <span class="text-2xl font-bold text-white">R$ {{ kpis.saldo.value | number:'1.2-2' }}</span>
      </div>

      <div class="flex flex-column gap-3">
        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Desempenho do Mês</h3>
        
        <div class="flex justify-content-between align-items-center p-3 rounded-lg" style="background: rgba(255,255,255,0.03);">
          <div class="flex align-items-center gap-3">
            <div class="w-2rem h-2rem rounded-circle flex align-items-center justify-content-center text-green-500" style="background: rgba(34, 197, 94, 0.1);">
              <i class="pi pi-arrow-up"></i>
            </div>
            <span class="text-gray-300">Receitas</span>
          </div>
          <span class="font-bold text-green-400">R$ {{ kpis.receitas.value | number:'1.2-2' }}</span>
        </div>

        <div class="flex justify-content-between align-items-center p-3 rounded-lg" style="background: rgba(255,255,255,0.03);">
          <div class="flex align-items-center gap-3">
            <div class="w-2rem h-2rem rounded-circle flex align-items-center justify-content-center text-red-500" style="background: rgba(239, 68, 68, 0.1);">
              <i class="pi pi-arrow-down"></i>
            </div>
            <span class="text-gray-300">Despesas</span>
          </div>
          <span class="font-bold text-red-400">{{ kpis.despesas.value > 0 ? '-' : '' }} R$ {{ kpis.despesas.value | number:'1.2-2' }}</span>
        </div>
      </div>
      
      <div class="mt-auto pt-4 border-top-1 border-gray-800">
        <div class="p-3 rounded-xl border border-gray-700" style="background: linear-gradient(135deg, #1e293b, #0f172a);">
          <h4 class="font-medium mb-2 text-gray-200">Dica Financeira</h4>
          <p class="text-sm text-gray-400 leading-relaxed m-0">
            Seu saldo está positivo! Considere investir 20% do excedente em Renda Fixa.
          </p>
        </div>
      </div>
    </div>
  </div>
</p-sidebar>

<!-- AI Assistant Dialog -->
<p-dialog 
  [(visible)]="aiVisible" 
  [modal]="true" 
  [style]="{width: '450px', maxWidth: '90vw'}" 
  header="Finance AI Assistant" 
  styleClass="ai-dialog"
  [draggable]="false"
  [resizable]="false">
  
  <div class="ai-chat-container">
    <div class="chat-messages" #chatContainer>
      <div *ngFor="let msg of aiChatHistory" class="message" [ngClass]="msg.role">
        <div class="message-content">
          <i class="pi" [ngClass]="msg.role === 'assistant' ? 'pi-bolt text-purple-400' : 'pi-user text-blue-400'"></i>
          <p>{{ msg.content }}</p>
        </div>
      </div>
      <div *ngIf="aiLoading" class="message assistant loading">
        <div class="message-content">
          <i class="pi pi-spin pi-spinner text-purple-400"></i>
          <p>Analisando dados...</p>
        </div>
      </div>
    </div>
    
    <div class="chat-input-area">
      <input type="text" pInputText [(ngModel)]="aiQuery" (keydown.enter)="sendAiQuery()" placeholder="Pergunte sobre suas finanças..." [disabled]="aiLoading" />
      <button pButton icon="pi pi-send" class="p-button-rounded p-button-text" (click)="sendAiQuery()" [disabled]="!aiQuery.trim() || aiLoading"></button>
    </div>
  </div>
</p-dialog>
