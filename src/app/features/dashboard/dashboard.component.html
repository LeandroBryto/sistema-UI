<div class="dashboard">
  <header class="top">
    <div class="avatar">{{ (username || 'U').charAt(0).toUpperCase() }}</div>
    <div class="hello">
      <span>Bem-vindo,</span>
      <h2>{{ username || 'UsuÃ¡rio' }}</h2>
      <span class="role-badge" *ngIf="isAdmin()">ADMIN</span>
    </div>
    <div class="actions">
      <app-settings-menu *ngIf="isAdmin()" />
      <button class="logout" (click)="logout()">Sair</button>
    </div>
  </header>

  <section class="balance">
    <div class="left">
      <div class="label">Saldo Atual</div>
      <div class="value">R$ {{ carteira?.saldoAtual | number:'1.2-2' }}</div>
      <div class="trend">
        Comprometimento: {{ carteira?.percentualComprometido | number:'1.0-1' }}%
      </div>
      <div class="trend">Previsto no mÃªs: R$ {{ carteira?.saldoPrevistoDoMes | number:'1.2-2' }}</div>
    </div>
    <div class="right">
      <span [class]="estadoClass(carteira?.saudeFinanceira)">{{ carteira?.saudeFinanceira || 'â€”' }}</span>
      
    </div>
    <button class="refresh" (click)="loadData()" [disabled]="loading">
      {{ loading ? '...' : 'âŸ³' }}
    </button>
  </section>

  <section class="quick">
    <a class="qcard" *ngIf="isAdmin()" routerLink="/admin">Painel de Controle</a>
    <a class="qcard" routerLink="/receitas">Receitas</a>
    <a class="qcard" routerLink="/despesas">Despesas</a>
    <a class="qcard" routerLink="/investimentos">Investimentos</a>
  </section>

  <section class="ad">
    <div class="ad-frame" (mouseenter)="stopAdTimer()" (mouseleave)="startAdTimer()">
      <img [src]="ads[currentAd]" alt="Publicidade" class="ad-img" (error)="onAdError()" />
      <button class="ad-nav left" (click)="prevAd()" aria-label="Anterior">â€¹</button>
      <button class="ad-nav right" (click)="nextAd()" aria-label="PrÃ³ximo">â€º</button>
    </div>
  </section>

  <!-- BotÃ£o Flutuante IA -->
  <div class="ai-fab-container">
    <p-button 
      icon="pi pi-sparkles" 
      [rounded]="true" 
      size="large" 
      (onClick)="aiToggle()" 
      styleClass="p-button-raised p-button-help p-button-lg shadow-4"
      pTooltip="Falar com IA"
      tooltipPosition="left">
    </p-button>
  </div>

  <!-- Chat Dialog -->
  <p-dialog 
    header="Assistente Financeiro" 
    [(visible)]="aiVisible" 
    position="bottomright" 
    [style]="{ width: '380px', height: '500px', margin: '0 20px 80px 0' }" 
    [modal]="false"
    [draggable]="false"
    [resizable]="false"
    [closeOnEscape]="true"
    [dismissableMask]="false"
    appendTo="body"
    styleClass="ai-chat-dialog">
    
    <div class="chat-content">
      <div class="chat-messages">
        <div *ngFor="let msg of aiChatHistory" [class]="'message-row ' + msg.sender">
          <p-avatar *ngIf="msg.sender === 'ai'" icon="pi pi-android" shape="circle" size="normal" styleClass="mr-2"></p-avatar>
          <div class="message-bubble">{{ msg.text }}</div>
        </div>
        <div *ngIf="aiLoading" class="message-row ai">
          <p-avatar icon="pi pi-spin pi-spinner" shape="circle" size="normal" styleClass="mr-2"></p-avatar>
          <div class="message-bubble">Digitando...</div>
        </div>
      </div>
      
      <form [formGroup]="aiForm" (ngSubmit)="aiAsk()" class="chat-input-area">
        <div class="p-inputgroup">
          <input pInputText type="text" formControlName="message" placeholder="Pergunte sobre suas finanÃ§as..." />
          <button pButton type="submit" icon="pi pi-send" [disabled]="aiForm.invalid || aiLoading"></button>
        </div>
      </form>
    </div>
  </p-dialog>

  <p class="error" *ngIf="error">{{ error }}</p>

  <section class="goals">
    <div class="goals-header">
      <h3>Resumo do mÃªs</h3>
      <a routerLink="/relatorios" class="view-all">Ver detalhes</a>
    </div>
    <div class="goal-card">
      <div class="head">
        <span class="icon">ğŸ†</span>
        <div>
          <div class="title">Maiores despesas</div>
          <div class="meta">Top 5 do mÃªs</div>
        </div>
        <span [class]="estadoClass(resumo?.saudeFinanceira)">{{ resumo?.saudeFinanceira || 'â€”' }}</span>
      </div>
      <div *ngIf="resumo?.rankingMaioresDespesas; else noRank">
        <div class="bar-row" *ngFor="let kv of (resumo?.rankingMaioresDespesas | keyvalue)">
          <span class="cat">{{ kv.key }}</span>
          <div class="track"><div class="progress warn" [style.width.%]="barWidth(kv.value, resumo?.totalDespesas)"></div></div>
          <span class="val">R$ {{ kv.value | number:'1.2-2' }}</span>
        </div>
      </div>
      <ng-template #noRank><p class="caption">Sem ranking disponÃ­vel</p></ng-template>
    </div>

    <div class="goal-card">
      <div class="head">
        <span class="icon">ğŸ’¡</span>
        <div>
          <div class="title">SugestÃ£o automÃ¡tica</div>
          <div class="meta">Baseada na saÃºde financeira</div>
        </div>
      </div>
      <p class="caption">{{ resumo?.sugestaoAutomatica || 'â€”' }}</p>
    </div>
  </section>

  <p class="error" *ngIf="error">{{ error }}</p>

  
</div>
